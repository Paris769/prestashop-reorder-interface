<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gestione Riordini</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 20px;
        }
        h1, h2 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        select, input[type="number"] {
            padding: 5px;
            margin-right: 10px;
        }
        button {
            padding: 8px 12px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Gestione Riordini</h1>
    <label for="customerSelect">Seleziona Cliente:</label>
    <select id="customerSelect" onchange="loadRecommendations()">
        <!-- Options will be populated by JS -->
    </select>
    
    <h2>Prodotti Raccomandati</h2>
    <table id="recommendationTable">
        <thead>
            <tr>
                <th>Prodotto</th>
                <th>Quantità proposta</th>
                <th>Punteggio (0-1)</th>
                <th>Motivazione</th>
                <th>Quantità (modifica)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be generated by JS -->
        </tbody>
    </table>
    
    <h2>Aggiungi Prodotto</h2>
    <select id="productSelect">
        <!-- Product options will be populated by JS -->
    </select>
    <input type="number" id="additionalQty" value="1" min="1">
    <button onclick="addProduct()">Aggiungi</button>
    
    <br><br>
    <button onclick="submitOrder()">Finalizza e Invia</button>
    
    <script>
        // Recommendations data (embedded JSON)
        const recommendationsData = [{"customer_id": 3, "product_id": 102.0, "name": "Bicchieri plastica", "predicted_qty": 8, "normalized_score": 1.0, "reason": "Reorder recommendation"}, {"customer_id": 3, "product_id": 101.0, "name": "Piatti compostabili", "predicted_qty": 1, "normalized_score": 0.1150338443245105, "reason": "Associated with product 102.0"}, {"customer_id": 2, "product_id": 105.0, "name": "Tovaglioli carta", "predicted_qty": 20, "normalized_score": 1.0, "reason": "Reorder recommendation"}, {"customer_id": 2, "product_id": 101.0, "name": "Piatti compostabili", "predicted_qty": 3, "normalized_score": 0.5976176940935708, "reason": "Reorder recommendation"}, {"customer_id": 2, "product_id": 104.0, "name": "Guanti monouso", "predicted_qty": 5, "normalized_score": 0.5976176940935708, "reason": "Reorder recommendation"}, {"customer_id": 2, "product_id": 102.0, "name": "Bicchieri plastica", "predicted_qty": 1, "normalized_score": 0.1071428571428571, "reason": "Associated with product 101.0"}, {"customer_id": 1, "product_id": 103.0, "name": "Detergente sgrassante", "predicted_qty": 2, "normalized_score": 1.0, "reason": "Reorder recommendation"}, {"customer_id": 1, "product_id": 101.0, "name": "Piatti compostabili", "predicted_qty": 2, "normalized_score": 0.3459992572156332, "reason": "Reorder recommendation"}, {"customer_id": 1, "product_id": 102.0, "name": "Bicchieri plastica", "predicted_qty": 3, "normalized_score": 0.3459992572156332, "reason": "Reorder recommendation"}, {"customer_id": 1, "product_id": 104.0, "name": "Guanti monouso", "predicted_qty": 3, "normalized_score": 0.2668956584754025, "reason": "Associated with product 101.0"}];

        // Product list (id and name)
        const productsList = [
            { id: 101, name: "Piatti compostabili" },
            { id: 102, name: "Bicchieri plastica" },
            { id: 103, name: "Detergente sgrassante" },
            { id: 104, name: "Guanti monouso" },
            { id: 105, name: "Tovaglioli carta" }
        ];

        // Populate customer dropdown
        function populateCustomerSelect() {
            const customerSelect = document.getElementById('customerSelect');
            // Get unique customer IDs
            const customerIds = [...new Set(recommendationsData.map(item => item.customer_id))];
            customerIds.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = 'Cliente ' + id;
                customerSelect.appendChild(opt);
            });
        }

        // Populate product dropdown for adding products
        function populateProductSelect() {
            const productSelect = document.getElementById('productSelect');
            productsList.forEach(prod => {
                const opt = document.createElement('option');
                opt.value = prod.id;
                opt.textContent = prod.name;
                productSelect.appendChild(opt);
            });
        }

        // Load recommendations for selected customer
        function loadRecommendations() {
            const customerId = parseInt(document.getElementById('customerSelect').value);
            const tableBody = document.getElementById('recommendationTable').querySelector('tbody');
            // Clear existing rows
            tableBody.innerHTML = '';
            // Filter recommendationsData
            const recs = recommendationsData.filter(item => item.customer_id === customerId);
            recs.forEach(item => {
                addRowToTable(item.product_id, item.name, item.predicted_qty, item.normalized_score, item.reason);
            });
        }

        // Helper to add a row to the recommendation table
        function addRowToTable(productId, productName, quantity, score, reason) {
            const tableBody = document.getElementById('recommendationTable').querySelector('tbody');
            // Check if product already exists in table
            const existingRow = document.querySelector(`tr[data-product-id='${productId}']`);
            if (existingRow) {
                // Update quantity
                existingRow.querySelector('input').value = quantity;
                existingRow.querySelector('.score').textContent = score.toFixed(3);
                existingRow.querySelector('.reason').textContent = reason;
                return;
            }
            const row = document.createElement('tr');
            row.setAttribute('data-product-id', productId);
            row.innerHTML = `
                <td>${productName}</td>
                <td>${quantity}</td>
                <td class="score">${score.toFixed(3)}</td>
                <td class="reason">${reason}</td>
                <td><input type="number" value="${quantity}" min="1" style="width:60px;"></td>
            `;
            tableBody.appendChild(row);
        }

        // Add product manually
        function addProduct() {
            const prodSelect = document.getElementById('productSelect');
            const selectedProdId = parseInt(prodSelect.value);
            const selectedProd = productsList.find(p => p.id === selectedProdId);
            const quantity = parseInt(document.getElementById('additionalQty').value);
            if (!selectedProd) return;
            // Default score and reason for manual addition
            addRowToTable(selectedProd.id, selectedProd.name, quantity, 0.0, 'Aggiunto manualmente');
        }

        // Submit order (demo)
        function submitOrder() {
            const tableRows = document.getElementById('recommendationTable').querySelectorAll('tbody tr');
            const orderData = [];
            tableRows.forEach(row => {
                const prodId = parseInt(row.getAttribute('data-product-id'));
                const quantity = parseInt(row.querySelector('input').value);
                orderData.push({ product_id: prodId, quantity: quantity });
            });
            // For now, just show the data in an alert or console
            alert('Ordine generato:\n' + JSON.stringify(orderData, null, 2));
            console.log('Ordine inviato:', orderData);
            // Qui si potrebbe chiamare l'API di PrestaShop per creare il carrello/ordine
        }

        // Initialize the page
        populateCustomerSelect();
        populateProductSelect();
        // Load recommendations for the first customer by default
        document.getElementById('customerSelect').selectedIndex = 0;
        loadRecommendations();
    </script>
</body>
</html>
